name: Claude Code

on:
  issue_comment:
    types:
      - created
  pull_request_review_comment:
    types:
      - created
  issues:
    types:
      - opened
      - assigned
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:
    inputs:
      seed:
        description: Random seed for deterministic behavior
        required: False
        default: 42
      run_id:
        description: Unique run identifier
        required: False
        default: run-1

jobs:
  claude:
    if: '(github.event_name == ''issue_comment'' && contains(github.event.comment.body,
      ''@claude'')) ||

      (github.event_name == ''pull_request_review_comment'' && contains(github.event.comment.body,
      ''@claude'')) ||

      (github.event_name == ''pull_request_review'' && contains(github.event.review.body,
      ''@claude'')) ||

      (github.event_name == ''issues'' && (contains(github.event.issue.body, ''@claude'')
      || contains(github.event.issue.title, ''@claude'')))

      '
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
    - name: '[Instrumentation] Job Start - claude'
      run: 'echo "::notice::JOB_START::claude::$(date -u +%s%N)"

        echo "RUNNER_INFO: $(uname -a)"

        '
    - name: '[Instrumentation] Pre-Checkout repository'
      run: 'echo "::notice::DETERMINISM_START::claude::0::$(date -u +%s%N)"

        echo "ENV_SNAPSHOT=$(env | sort | sha256sum | cut -d'' '' -f1)"

        '
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: '[Instrumentation] Post-Checkout repository'
      run: 'echo "::notice::DETERMINISM_END::claude::0::$(date -u +%s%N)"

        if [ -d "build" ]; then find build -type f -exec sha256sum {} \; fi

        '
    - name: '[Instrumentation] Pre-Run Claude Code'
      run: 'echo "::notice::DETERMINISM_START::claude::1::$(date -u +%s%N)"

        echo "ENV_SNAPSHOT=$(env | sort | sha256sum | cut -d'' '' -f1)"

        '
    - name: Run Claude Code
      id: claude
      uses: anthropics/claude-code-action@beta
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        additional_permissions: 'actions: read

          '
    - name: '[Instrumentation] Post-Run Claude Code'
      run: 'echo "::notice::DETERMINISM_END::claude::1::$(date -u +%s%N)"

        if [ -d "build" ]; then find build -type f -exec sha256sum {} \; fi

        '
    - name: '[Instrumentation] Job End - claude'
      run: 'echo "::notice::JOB_END::claude::$(date -u +%s%N)"

        '
